angular.module('blog.controllers', ['blog.factories'])
    .controller('BlogCtrl', function (Blog) {

        this.rpp = 15;
        this.total = 0;
        this.posts = [];

        var me = this;

        this.setLocale = function (locale) {
            //unset the old one
            this.options.locales[this.options.locale].active = false;
            //set the new one and cache active one
            this.options.locales[locale].active = true;
            this.options.locale = locale;
        };

        this.activeTab = function (locale) {
            return this.locale == locale;
        };

        this.list = function (table) {

            var pagination = table.pagination;
            var page = Math.ceil(pagination.start / me.rpp) + 1;

            Blog.query({
                page: page
            }, function (response, callback) {
                me.total = response.total;
                me.posts = response.data;
                pagination.numberOfPages = response.last_page;
            });
        };
    })

    .controller('BlogImageCtrl', function (BlogImage){
        this.images = [];



    })

    .controller('BlogDetailCtrl', function ($state, Blog, $scope, BlogImage) {

        //when creating, it should get locked so it won't trigger another save, till we have the id back from the server.
        this.locked = false;

        var me = this,
            id = $state.params.postId;


        this.load = function (id) {
            //also pass through the locale parameter (not the UI locale, but the input locale for the post itself
            Blog.get({id: id}, function (post) {
                me.post = post;
            });
        };

        function unlock() {
            return setTimeout(function () {
                me.locked = false;
            }, 3000);
        }

        this.save = function () {

            if (!this.locked)
            {
                if (!this.post.id)
                {
                    this.post.$save(function (post) {
                        $state.go('admin.blog.post', {postId: post.id});
                    });
                }
                else
                {
                    this.locked = true;

                    this.post.$update(function () {
                        unlock();
                    });
                }
            }
        };

        //image uploader
        $scope.dropzone = {
            options: {
                url: 'api/admin/blog/' + id + '/image',
                clickable: true,
                maxFileSize: 10
            },
            handlers: {
                success: function (file, image, xhr) {
                    me.post.images.push(image);
                    this.removeFile(file);
                    $scope.$apply();
                }
            }
        };

        this.updateImage = function (img) {
            img.postId = me.post.id;
            image = new BlogImage(img);
            image.$update();
        };

        this.deleteImage = function (id) {

            BlogImage.delete({
                postId: me.post.id,
                imageId: id
            }, function () {
                _.remove(me.post.images, function (value, index, array) {
                    return value.id == id;
                });
            });
        };

        //init with the post or an empty one
        id ? this.load(id) : this.post = new Blog();
    });

angular.module('blog.factories', ['ngResource'])
    .factory('Blog', function ($resource) {
        return $resource('api/admin/blog/:id', {id: '@id'}, {
            query: {
                isArray: false
            },
            get: {
                method: 'GET'
            },
            update: {
                method: 'PUT'
            }
        });
    })
    .factory('BlogImage', function ($resource) {
        var placeholders = {
            imageId: '@id',
            postId: '@postId'
        };

        return $resource('api/admin/blog/:postId/image/:imageId', placeholders, {
            query: {
                isArray: false
            },
            update: {
                method: 'PUT'
            }
        });
    });

function config($stateProvider) {

    $stateProvider
        .state('admin.blog', {
            abstract: true,
            url: "/blog",
            template: '<ui-view/>'
        })
        .state('admin.blog.posts', {
            url: "/posts",
            templateUrl: "templates/admin/blog/overview"
        })
        .state('admin.blog.post', {
            url: '/post/:postId',
            templateUrl: "templates/admin/blog/detail"
        });
}


angular.module('blog', ['blog.controllers', 'blog.factories'])
    .config(config);